# 表空间

> 为了更好的管理数据页，提出了表空间 的概念，对应文件系统上的一个或多个真实文件。
>
> 分为 系统表空间 以及 独立表空间。

### 页面类型

| 类型名称                | 十六进制 | 描述                    |
| ----------------------- | -------- | ----------------------- |
| FIL_PAGE_TYPE_ALLOCATED | 0x0000   | 最新分配，还未使用      |
| FIL_PAGE_UNDO_LOG       | 0x0002   | undo日志页              |
| FIL_PAGE_INODE          | 0x0003   | 存储段的信息            |
| FIL_PAGE_IBUF_FREE_LIST | 0x0004   | Change Buffer空闲列表   |
| FIL_PAGE_IBUF_BITMAP    | 0x0005   | Change Buffer的一些属性 |
| FIL_PAGE_TYPE_SYS       | 0x0006   | 存储一些系统数据        |
| FIL_PAGE_TYPE_TRX_SYS   | 0x0007   | 事务系统数据            |
| FIL_PAGE_TYPE_FSP_HDR   | 0x0008   | 表空间头部信息          |
| FIL_PAGE_TYPE_XDES      | 0x0009   | 存储区的一些属性        |
| FIL_PAGE_TYPE_BLOB      | 0x000A   | 溢出页                  |
| FIL_PAGE_INDEX          | 0x45BF   | 索引页，也就是数据页    |

------

### 区 (Extent)

```c
// 区的分类
// FREE、FREE_FRAG、FULL_FRAG直属于表空间
// FREE       空闲的区
// FREE_FRAG  有剩余空闲页面的碎片区
// FULL_FRAG  没有剩余空闲页面的碎片区
// FSEG       附属于某个段的区

struct ListNode {
  Prev Node Page Number; // 4字节
  Prev Node Offset; // 2字节
  Next Node Page Number; // 4字节
  Next Node Offset; // 2字节
};

// 描述区的结构
struct XDES Entry {
  // 8字节 该区所在的段，前提是该区分配给了某个段才有意义
  Segment ID;  
  // 12字节 链表 
  List Node;
  // 4字节 FREE、FREE_FRAG、FULL_FRAG、FSEG 
  State; 
  // 16字节(128位)，划分成64个部分，每个部分有2位，对应区中的一个页。第1位表示页是否空闲，第二位保留
  Page State Bitmap;
 };
```

- 连续的`64`个页就是一个区`（1M）`，每`256`个区划分为一组。

- 第一个组的最开始的3个页面的类型是固定的
  - FSP_HDR
  - IBUF_BITMAP
  - INODE
- 其余各组最开始的2个页面的类型是固定的
  - XDES
  - IBUF_BITMAP

------

### 段 (Segment)

```
INODE Entry

每个段对应一个INODE Entry结构

segment id、NOT_FULL_N_USED、三个链表、Fragment Array Entry 对应一个零散页面
```

- 段是某些零散的页面以及一些完整的区的集合
- 叶子节点与非叶子节点都有自己独有的区
- 一个索引会生成两个段 `叶子节点段`（存放叶子节点的区的集合）与`非叶子节点段`（存放非叶子节点的区的集合）
- 段是以区为单位申请的，先是从某个碎片区以单个页面分配存储空间，占用32个碎片区页面之后，按照完整的区分配

------

### List Base Node

包含链表的头尾节点

