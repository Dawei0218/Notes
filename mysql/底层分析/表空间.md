# 表空间

### 页面类型

| 类型名称                | 十六进制 | 描述                    |
| ----------------------- | -------- | ----------------------- |
| FIL_PAGE_TYPE_ALLOCATED | 0x0000   | 最新分配，还未使用      |
| FIL_PAGE_UNDO_LOG       | 0x0002   | undo日志页              |
| FIL_PAGE_INODE          | 0x0003   | 存储段的信息            |
| FIL_PAGE_IBUF_FREE_LIST | 0x0004   | Change Buffer空闲列表   |
| FIL_PAGE_IBUF_BITMAP    | 0x0005   | Change Buffer的一些属性 |
| FIL_PAGE_TYPE_SYS       | 0x0006   | 存储一些系统数据        |
| FIL_PAGE_TYPE_TRX_SYS   | 0x0007   | 事务系统数据            |
| FIL_PAGE_TYPE_FSP_HDR   | 0x0008   | 表空间头部信息          |
| FIL_PAGE_TYPE_XDES      | 0x0009   | 存储区的一些属性        |
| FIL_PAGE_TYPE_BLOB      | 0x000A   | 溢出页                  |
| FIL_PAGE_INDEX          | 0x45BF   | 索引页，也就是数据页    |

------

### 区

连续的`64`个页就是一个区`（1M）`，每`256`个区划分为一组。

- 第一个组的最开始的3个页面的类型固定
  - FSP_HDR 登记整个表空间的一些整体属性以及本组所有区的属性。
  - IBUF_BITMAP 存储关于Change Buffer的一些信息。
  - INODE 存储许多INODE Entry的结构。

- 其余各组最开始两个页面类型固定
  - XDES 登记本组256个区的属性。
  - IBUF_BITMAP 存储关于Change Buffer的一些信息。


------

### 段

- 叶子节点与非叶子节点都有自己独有的区
- 存放叶子节点的区的集合就算是一个段，存放非叶子节点的区的集合也算一个段
- 一个索引会生成两个段 `叶子节点段`与`非叶子节点段`
- 段是以区为单位申请的，数据量比较小的表先使用碎片区，当段占用了32个碎片区页面时，在以完整的区为单位分配存储空间

------

### 区的分类

FREE、FREE_FRAG、FULL_FRAG直属于表空间

| 状态名    | 含义                     |
| --------- | ------------------------ |
| FREE      | 空闲的区                 |
| FREE_FRAG | 有剩余空闲页面的碎片区   |
| FULL_FRAG | 没有剩余空闲页面的碎片区 |
| FSEG      | 附属于某个段的区         |

------

### XDES Entry

每一个区都对应一个XDES Entry结构

| 名称              | 描述                                                         |
| ----------------- | ------------------------------------------------------------ |
| Segment ID        | 该区所在的段                                                 |
| List Node         | 链表                                                         |
| State             | FREE、FREE_FRAG、FULL_FRAG、FSEG                             |
| Page State Bitmap | 128位被划分为64个部分，每个部分两位，对应一个页。第一位表示页是否空闲，第二位保留 |

通过List Node连接成3个链表

- FREE的区对应的XDES Entry结构连接成一个链表
- FREE_FRAG的区对应的XDES Entry结构连接成一个链表
- FULL_FRAG的区对应的XDES Entry结构连接成一个链表

每个段都会建立3个链表，都是附属于某个段

- FREE的区对应的XDES Entry结构连接成一个链表
- NOT_FULL 仍有空闲页面对应的XDES Entry结构会加入这个链表
- FULL 已经没有空闲页面的区对应的XDES Entry结构会加入这个链表

------

### List Base Node

包含链表的头尾节点

------

### INODE Entry

每个段对应一个INODE Entry结构

segment id、NOT_FULL_N_USED、三个链表、Fragment Array Entry 对应一个零散页面
