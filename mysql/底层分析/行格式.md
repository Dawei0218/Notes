# 行格式

> 基于InnoDB存储引擎

### 行格式类型

- COMPACT
- REDUNDANT
- DYNAMIC (default)
- COMPRESSED

------

### COMPACT行格式

```c
[变长字段长度列表][NULL值列表][记录头信息][row_id][trx_id][roll_pointer][列1的值]...[列n的值]
```

- 变长字段长度列表
  - 用于记录`变长字段`（VARCHAR(M)、TEXT、BLOB类型，存储字节数不固定）并且`非NULL值`的列占用的字节数
  - 按照列的顺序逆序存储（第一列放在低位）
  - 长度存储规则（怎么区分使用了1字节还是2字节呢？如果字节的第一个位为0是单独字段长度，为1是半个字段长度）
    - 某个字符集最多需要`W`字节表示一个字符
    - 对于变成字段 VARCHAR(M) 表示能存储最多`M`个字符
    - 变长字段实际存储的字符串占用的字节数是`L`
    - 如果 M * W <= 255 用1字节来表示真实数据占用的字节数
    - 如果 M * W > 255 时，则分为下面两种情况
      - 如果 L <= 127 用1字节
      - 如果 L > 127 用2字节
  - 如果采用变长字符集也会记录长度
  
- NULL值列表
  - 每个允许为NULL的列对应一个二进制位，为1时表示NULL
  - 二进制位按照列的顺序逆序排列（第一列放在低位）
  - NULL值列必须用整个字节的位表示，不足一字节高位补零
  
- 记录头信息

  | 名称         | 大小(bit) | 描述                                                         |
  | ------------ | --------- | ------------------------------------------------------------ |
  | 预留位1      | 1         | 没有使用                                                     |
  | 预留位2      | 1         | 没有使用                                                     |
  | deleted_flag | 1         | 标记该记录是否被删除，所有被删除记录会组成一个垃圾链表       |
  | min_rec_flag | 1         | B+树每层非叶子结点中的最小记录为1，其他为0                   |
  | n_owned      | 4         | 一个页面中的记录都会分为若干组，组长记录的该值表示该组的记录数，其它记录都是0 |
  | heap_no      | 13        | 表示当前记录在记录堆的位置信息                               |
  | record_type  | 3         | 表示当前记录类型。0 普通记录，1 B+树非叶子节点的目录项纪录，2 Infimum，3 Supremum |
  | next_record  | 16        | 表示下一条记录的相对位置                                     |

- 隐藏列

  | 列名                       | 是否必须 | 占用空间 | 描述                                                         |
  | -------------------------- | -------- | -------- | ------------------------------------------------------------ |
  | row_id (DB_ROW_ID)         | 否       | 6字节    | 行ID，唯一标识一条纪录。优先使用用户自定义主键，其次才会选取一个不允许存储NULL值的UNIQUE健作为主键，最后才会默认添加一个名为row_id的隐藏列作为主键 |
  | trx_id (DB_TRX_ID)         | 是       | 6字节    | 事务id                                                       |
  | roll_pointer (DB_ROLL_PTR) | 是       | 7字节    | 回滚指针                                                     |

------

### REDUNDANT行格式

> MySQL5.0之前使用

```
[字段长度偏移列表][记录头记录][列1的值]...[列n的值]
```

- 字段偏移长度列表

  - 记录所有列（包括隐藏列）的长度信息按照逆序存储，偏移记录的是真实数据结束的位置
  - 采用两个相邻偏移量的差值来计算各个列的长度
  - 整个记录的真实数据占用的字节数不大于127，每个列对应的偏移量用1字节表示
  - 整个记录的真实数据占用的字节数大于127，但不大于32767，每个列对应的偏移量用2字节
  - 大于32767时，记录放到溢出页，本页只保留前768个字节和20个字节的溢出页面地址

- 记录头信息

  | 名称            | 大小(bit) | 描述                                                         |
  | --------------- | :-------- | :----------------------------------------------------------- |
  | 预留位1         | 1         | 没有使用                                                     |
  | 预留位2         | 1         | 没有使用                                                     |
  | deleted_flag    | 1         | 标记该记录是否被删除                                         |
  | min_rec_flag    | 1         | B+树的每层非叶子节点中的最小的目录项记录都会添加该标记       |
  | n_owned         | 4         | 一个页面中的记录都会分为若干组，组长记录的该值表示该组的记录数，其它记录都是0 |
  | heap_no         | 13        | 表示当前记录在页面堆的位置信息                               |
  | n_field         | 10        | 表示记录中列的数量                                           |
  | 1byte_offs_flag | 1         | 标记字段长度偏移列表中每个列对应的偏移量字节数，1表示1字节 0表示2字节 |
  | next_record     | 16        | 表示下一条记录的相对位置                                     |

- 偏移量的第一个比特位判断是否为NULL，第一个比特位为1，该值就是NULL

------

### DYNAMIC和COMPRESSED

- 与COMPACT行格式类似
- DYNAMIC溢出只保留指针，不会存储768个字节
- COMPRESSED会压缩
