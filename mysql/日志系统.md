# 日志系统

修改时才会涉及的两个日志模块。

### redo log

redo log是引擎层日志，记录的是某个数据页做了什么修改。

如果每次更新操作都需要写进磁盘，磁盘找到对应记录，然后在更新，整个过程IO成本、查询成本都非常高。

以上问题采用WAL（Write-Ahead Logging）解决，当一条记录需要更新时，引擎会把记录写到redo log，并更新内存，等系统空闲的时候在写入磁盘；如果redo log记满了，就会更新一部分记录到磁盘中，把redo log清除一部分。

------

### binlog

binlog是Server层日志，记录的是sql语句，用于归档。

binlog是追加写，文件到达一定大小，就会切换到另一个文件。

------

### 执行流程

```sql
update T set c=c+1 where ID=2;
```

1. 执行器找引擎取ID=2这一行，如果数据页在内存中，直接返回给执行器；否则，需要先从磁盘读入内存，然后在返回。

2. 执行器拿到行数据，把这个值+1，在调入引擎层写入新数据。

3. 引擎将新数据更新到内存中，同时记录到redo log中，此时redo log已经prepare。然后告知执行器执行完成，随时可以提交事务。
4. 执行器生成此操作的binlog，并把binlog写入磁盘。
5. 执行器调用引擎的事务提交接口，引擎把刚刚写入的redo log改成提交，更新完成。

