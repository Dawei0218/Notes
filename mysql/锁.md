# 锁

### 全局锁

```mysql
flush tables with read lock;
unlock tables;
```

对整个数据库实例加锁，整个库处于只读状态，数据更新语句、数据定义语句和更新类事务提交会被阻塞。

典型的使用场景，做全库逻辑备份。

------

### 表级锁

#### 表锁

```mysql
lock tables tb_name read/write; # read不允许写 write不允许读写
unlock tables;
```

#### MDL(matadata lock)

5.5引入MDL，不需要显示使用，在访问表的时候会自动加上，在事务提交时才会释放。

对表增删改查时，加读锁。对表结构修改时，加写锁。

------

### 行锁

在需要时加锁，commit时释放

要把最可能造成锁冲突、最可能影响并发度的锁尽量往后放。

------

### 死锁

不同的线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会出现无线等待。

innodb_lock_wait_timeout设置锁超时，时间太长没意义，时间太短可能影响简单的锁等待。

innodb_deadlock_detect锁检测，如果要加锁的行上有锁就会进行检测。

 

