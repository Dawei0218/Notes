# 事务

### 事务特性（ACID）

***原子性***（Atomicity）

​	一个事务必须被视为不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚。

***一致性***（Consistency）

​	在执行事务奔溃了，事务没有提交也不会影响到数据库的数据。

***隔离性***（Isolation）

​	一个事务所做修改在提交之前，对其他事务是不可见的。

***持久性***（Durability）

​	一旦事务提交，就会永久保存在数据库中，即使崩溃了也不会修改时。

------

### 事务隔离的实现

每条记录在更新的时候都会同时记录一条回滚操作，通过回滚操作就可以得到前一个值，不同时刻的会有不同的read-view。

当系统里面没有比这个回滚日志更早的read-view时，才会删除，长事务会导致回滚日志特别大。

------

### MVCC

用于支持读提交和可重复读隔离级别。

每个行都有隐藏的列，row trx_id以及回滚日志指针。每个事务都有唯一id，记为trx_id，在事务更新的时候都会赋值给row trx_id。

Innodb在事务启动瞬间，构建了一个数组，是所有活跃（启动了没提交）的事务id。事务里面最小的事务id是低水位，而当前系统里面创建过的事务id+1记为高水位。如果row trx_id低于低水位就是已经提交的可见，如果大于高水位就不可见。大于低水位，小于高水位的row trx id，还分为两种情况，在数组中就是还在活跃中的不可见，如果不在就是已经提交的可见。

-------

### 当前读

修改语句是先读后写，总是读最新的数据。





