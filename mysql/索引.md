# 索引相关

### 主键索引和非主键索引

主键索引的叶子节点存储的是行数据（一个页里有多个行），在InnoDB里，主键索引又叫聚簇索引。

非主键索引的叶子节点存储的是主键的值，在InnoDB里，非主键索引又叫二级索引。

------

### 回表

主键查询通过B+树就能找到整行数据。

非主键索引通过B+树找到的主键的值，在去主键索引查找到行数据，这个过程就是回表。

------

### 覆盖索引

查询的列，在联合索引中存在时，就不需要回表，直接就能返回。

------

### 最左前缀原则

联合索引中，索引项按照索引定义的字段顺序排序的。

查询的时候，只要满足最左原则就可以使用到索引。

------

### 索引下推

```sql
联合索引 name, age
select * from t where name = 'xx' and age < 10;
```

在mysql5.6之前，只能通过name索引，一个一个回表判断条件是否满足age小于10；

而5.6则引入了索引下推优化，对索引中包含的字段先做判断，减少回表次数。

------

### change buffer

只能应用于普通索引。当需要更新一个数据页时，如果数据页在内存中就直接更新。如果数据页不在内存中，在不影响数据一致性的前提下，InnoDB会将操作缓存在change buffer中。（更新索引记录时，可以缓存）

change buffer也会写入磁盘中，访问数据页会触发merge，后台线程定期merge，shutdown也会触发。

change buffer也会记入redo log中。

------

### 普通索引和唯一索引区别

查询区别：

1. 普通索引在查询时，会多查询一次，查询到不满足不满足条件的记录。
2. 唯一索引定义了唯一性，查找到满足条件的记录，就会停止继续检索。
3. 多查询一次的代价微乎其微，因为从磁盘中读出来是以页为单位。

更新区别：

1. 如果数据页在内存中，唯一索引需要判断唯一性以外，都是直接更新内存。
2. 唯一索引每一次都需要判断唯一性，所以要把数据页读入内存中，所以没必要使用change buffer。
3. 普通索引不要判断唯一性，可以使用change buffer。

写多读少的场景下使用change buffer比较好，账单类、日志类系统。

------

### 如何给字符串字段加索引

使用前缀，预定一个可以接受的损失比例，比如5%，就可以就可以计算损失比。

倒序存储。

crc32。

------













