# 数据页结构

### 概览

```
[File Header (38字节)]
[Page Header (56字节)]
[Infimum + Supremum (26字节)] 两个虚拟记录
[User Records (大小不确定)]
[Free Space (大小不确定)]
[Page Directory (大小不确定)]
[File Tailer (8字节)]
```

每插入一条记录，从Free Space部分划分空间到User Records部分

------

### 记录头

| 名称         | 大小(bit) | 描述                                                   |
| ------------ | --------- | ------------------------------------------------------ |
| 预留位1      | 1         | 没有使用                                               |
| 预留位2      | 1         | 没有使用                                               |
| delete_mask  | 1         | 标记该记录是否被删除                                   |
| min_rec_mask | 1         | B+树每层非叶子结点中的最小记录都会添加                 |
| n_owned      | 4         | 表示当前记录拥有的记录数                               |
| heap_no      | 13        | 表示当前记录在记录堆的位置信息（User Rocords部分位置） |
| record_type  | 3         | 表示当前记录类型                                       |
| next_record  | 16        | 表示下一条记录的相对位置                               |

-------

### 最大/最小记录

都是由5字节的记录头以及8字节大小的一个固定部分组成

record_type为2、3分别代表最小以及最大记录

next_record从当前记录的真实记录到下一条`真实数据`的地址偏移，向左就是记录头，向右就是真实数据，其实也就是链表

------

### Page Directory

1. 吧所有正常的记录（包括最大最小记录，不包括被删除的记录）划分为几个组

2. 每个组里最大的记录的头信息得n_owned表示该记录有多少条记录
3. 吧每个组的最后一条记录的真实数据的地址偏移量单独读出来按照顺序存储到页目录。
4. 页目录中的地址偏移量也称为槽
5. 最小记录所在的分组只能有1条记录，最大记录所在的分组只能有1～8条之间，剩下的分组的条数范围是4～8条之间

------

### Page Header

| 名称              | 占用空间大小 | 描述                                                         |
| ----------------- | ------------ | ------------------------------------------------------------ |
| PAGE_N_DIR_SLOTS  | 2字节        | 在页目录中槽数量                                             |
| PAGE_HEAP_TOP     | 2字节        | 还未使用的空间最小地址，也就是说从该地址之后就是 Free Space  |
| PAGE_N_HEAP       | 2字节        | 本页中的记录的数量(包括最小和最大记录以及标记为删除的记录)   |
| PAGE_FREE         | 2字节        | 第一个已经标记为删除的记录地址(各个已删除的记录通过 next_record 也会组成一个单链 表，这个单链表中的记录可以被重新利用) |
| PAGE_GARBAGE      | 2字节        | 已删除记录占用的字节数                                       |
| PAGE_LAST_INSERT  | 2字节        | 最后插入记录的位置                                           |
| PAGE_DIRECTION    | 2字节        | 记录插入的方向，新插入记录的主键比上一条大，插入方向就是右边 |
| PAGE_N_DIRECTION  | 2字节        | 一个方向连续插入的记录数量                                   |
| PAGE_N_RECS       | 2字节        | 该页中记录的数量(不包括最小和最大记录以及被标记为删除的记录) |
| PAGE_MAX_TRX_ID   | 8字节        | 修改当前页的最大事务ID，该值仅在二级索引中定义               |
| PAGE_LEVEL        | 2字节        | 当前页在B+树中所处的层级                                     |
| PAGE_INDEX_ID     | 8字节        | 索引ID，表示当前页属于哪个索引                               |
| PAGE_BTR_SEG_LEAF | 10字节       | B+树叶子段的头部信息，仅在B+树的Root页定义                   |
| PAGE_BTR_SEG_TOP  | 10字节       | B+树非叶子段的头部信息，仅在B+树的Root页定义                 |

------

### File Header

| 名称                             | 占用空间大小 | 描述                                                         |
| -------------------------------- | ------------ | ------------------------------------------------------------ |
| FIL_PAGE_SPACE_OR_CHKSUM         | 4字节        | 页的校验和(checksum值)                                       |
| FIL_PAGE_OFFSET                  | 4字节        | 页号                                                         |
| FIL_PAGE_PREV                    | 4字节        | 上一个页的页号                                               |
| FIL_PAGE_NEXT                    | 4字节        | 下一个页的页号                                               |
| FIL_PAGE_LSN                     | 8字节        | 页面被最后修改时对应的日志序列位置(英文名是:Log Sequence Number) |
| FIL_PAGE_TYPE                    | 2字节        | 该页的类型                                                   |
| FIL_PAGE_FILE_FLUSH_LSN          | 8字节        | 仅在系统表空间的一个页中定义，代表文件至少被刷新到了对应的LSN值 |
| FIL_PAGE_ARCH_LOG_NO_OR_SPACE_ID | 4字节        | 页属于哪个表空间                                             |

-------

### File Trailer

8字节

前4个字节代表页的校验和

这个部分是和 File Header 中的校验和相对应的。每当一个页面在内存中修改了，在同步之前就要把它的校 验和算出来，因为 File Header 在页面的前边，所以校验和会被首先同步到磁盘，当完全写完时，校验和也 会被写到页的尾部，如果完全同步成功，则页的首部和尾部的校验和应该是一致的。如果写了一半儿断电 了，那么在 File Header 中的校验和就代表着已经修改过的页，而在 File Trialer 中的校验和代表着原先 的页，二者不同则意味着同步中间出了错。

后4个字节代表页面被最后修改时对应的日志序列位置(LSN) 这个部分也是为了校验页的完整性的，只不过我们目前还没说 LSN 是个什么意思，所以大家可以先不用管这

个属性。







