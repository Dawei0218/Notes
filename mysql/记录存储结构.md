# 记录存储结构

### 记录（行）格式

- COMPACT
- REDUNDANT
- DYNAMIC（默认）
- COMPRESSED

------

### COMPACT行格式

```c
[变长字段长度列表][NULL值列表][记录头信息][row_id][trx_id][roll_pointer][列1的值]...[列n的值]
```

- 变长字段长度列表
  - 用于记录变长字段（VARCHAR、TEXT、BLOB这些存储字节数不确定的类型）并且非NULL值的列占用的字节数
  - char类型，如果采用变长字符集也会记录，为空时只预留最小长度的空间（char(10) utf8字符集预留10字节），小于10字节直接更新，大于重新分配新的记录空间
  - 按照列的顺序逆序存储（第一列放在低位）
  - 占用字节数存储规则
    - 某个字符集一个字符最多需要的字节数为W，varchar(M)表示最多存储多少个字符为M，实际存储占用的字节数为L
    - M * W <= 255 用1字节存储占用的字节数
    - M * W > 255时（如果字节的第一位为0表示单独的字段长度，使用了1字节，如果为1就是使用了2个字节）
      - L <= 127 用1字节
      - L > 127用2字节
- NULL值列表
  - 每个允许为NULL的列对应一个二进制位，为1时表示NULL
  - 二进制位按照列的顺序逆序排列（第一列放在低位）
  - NULL值列必须用整个字节的位表示，不足一字节高位补零
- 记录头信息

  | 名称         | 大小(bit) | 描述                                   |
  | ------------ | --------- | -------------------------------------- |
  | 预留位1      | 1         | 没有使用                               |
  | 预留位2      | 1         | 没有使用                               |
  | delete_mask  | 1         | 标记该记录是否被删除                   |
  | min_rec_mask | 1         | B+树每层非叶子结点中的最小记录都会添加 |
  | n_owned      | 4         | 表示当前记录拥有的记录数               |
  | heap_no      | 13        | 表示当前记录在记录堆的位置信息         |
  | record_type  | 3         | 表示当前记录类型                       |
  | next_record  | 16        | 表示下一条记录的相对位置               |

- 隐藏列

  | 列名                       | 是否必须 | 占用空间 | 描述                                                         |
  | -------------------------- | -------- | -------- | ------------------------------------------------------------ |
  | row_id (DB_ROW_ID)         | 非必需   | 6字节    | 行id，在没有主键并且没有不允许为NULL的UNIQUE键的情况下才会添加 |
  | trx_id (DB_TRX_ID)         | 必需     | 6字节    | 事务id                                                       |
  | roll_pointer (DB_ROLL_PTR) | 必需     | 7字节    | 回滚指针                                                     |

------

### REDUNDANT行格式

> MySQL5.0之前使用

```
[字段长度偏移列表][记录头记录][列1的值]...[列n的值]
```

- 字段偏移长度列表

  - 记录所有列（包括隐藏列）的长度信息按照逆序存储
  - 采用两个相邻偏移量的差值来计算各个列的长度
  - 整个记录的真实的数据占用的字节数不大于127，每个列对应的偏移量用1字节
  - 整个记录真实数据占用的字节数大于127，但不大于32767，每个列对应的偏移量用2字节
  - 大于32767时，记录放到溢出页，本页只保留前768个字节和20个字节的溢出页面地址

- 记录头信息

  | 名称            | 大小(bit) | 描述                                                         |
  | --------------- | :-------- | :----------------------------------------------------------- |
  | 预留位1         | 1         | 没有使用                                                     |
  | 预留位2         | 1         | 没有使用                                                     |
  | delete_mask     | 1         | 标记该记录是否被删除                                         |
  | min_rec_mask    | 1         | B+树的每层非叶子节点中的最小记录都会添 加该标记              |
  | n_owned         | 4         | 表示当前记录拥有的记录数                                     |
  | heap_no         | 13        | 表示当前记录在页面堆的位置信息                               |
  | n_field         | 10        | 表示记录中列的数量                                           |
  | 1byte_offs_flag | 1         | 标记字段长度偏移列表中每个列对应的偏移量是 使用1字节还是2字节表示的 |
  | next_record     | 16        | 表示下一条记录的相对位置                                     |

- NULL值处理如果偏移量值为1，那么该列的值就是NULL

------

### DYNAMIC和COMPRESSED

dynamic溢出只保留指针，不会存储768个字节。

compressed会压缩
