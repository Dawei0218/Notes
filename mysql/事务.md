# 事务

### ACID

- 原子性（Atomicity）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）

------

### 隔离级别

> 为了解决脏读、不可重复读、幻读的问题

- 读未提交
- 读提交
- 可重复读
- 串行化

------

### 多版本并发控制

> 用于支持读提交和可重复读，以下说明为可重复读
>
> 会一个创建视图（read-view），访问时以视图的逻辑结果为准。
>
> 可重复读视图在事务启动时创建，读提交视图在每个SQL语句开始执行的时候创建。

每条记录在更新的时候都会同时记录一条回滚操作。同一条记录在系统中可以存在多个版本，这就是数据库的多版本并发控制（MVCC）



每次开启事务的时候有唯一id，transaction id，每个记录有一个隐藏列 row trx_id，吧transaction id赋值给行，通过undo log找到自己版本的数据



在系统里没有比这个undo log更早的read-view时删除



在 MySQL 5.5 及以前的版本，回滚日志是跟数据字典一起放在 ibdata 文件里的，即使长事务最终提交，回滚段被清理，文件也不会变小。我见过数据只有 20GB，而回滚段有 200GB 的库。最终只好为了清理回滚段，重建整个库。

